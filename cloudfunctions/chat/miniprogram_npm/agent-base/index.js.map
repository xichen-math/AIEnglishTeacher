{"version":3,"sources":["index.js","promisify.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nconst events_1 = require(\"events\");\r\nconst debug_1 = __importDefault(require(\"debug\"));\r\nconst promisify_1 = __importDefault(require(\"./promisify\"));\r\nconst debug = debug_1.default('agent-base');\r\nfunction isAgent(v) {\r\n    return Boolean(v) && typeof v.addRequest === 'function';\r\n}\r\nfunction isSecureEndpoint() {\r\n    const { stack } = new Error();\r\n    if (typeof stack !== 'string')\r\n        return false;\r\n    return stack.split('\\n').some(l => l.indexOf('(https.js:') !== -1 || l.indexOf('node:https:') !== -1);\r\n}\r\nfunction createAgent(callback, opts) {\r\n    return new createAgent.Agent(callback, opts);\r\n}\r\n(function (createAgent) {\r\n    /**\r\n     * Base `http.Agent` implementation.\r\n     * No pooling/keep-alive is implemented by default.\r\n     *\r\n     * @param {Function} callback\r\n     * @api public\r\n     */\r\n    class Agent extends events_1.EventEmitter {\r\n        constructor(callback, _opts) {\r\n            super();\r\n            let opts = _opts;\r\n            if (typeof callback === 'function') {\r\n                this.callback = callback;\r\n            }\r\n            else if (callback) {\r\n                opts = callback;\r\n            }\r\n            // Timeout for the socket to be returned from the callback\r\n            this.timeout = null;\r\n            if (opts && typeof opts.timeout === 'number') {\r\n                this.timeout = opts.timeout;\r\n            }\r\n            // These aren't actually used by `agent-base`, but are required\r\n            // for the TypeScript definition files in `@types/node` :/\r\n            this.maxFreeSockets = 1;\r\n            this.maxSockets = 1;\r\n            this.maxTotalSockets = Infinity;\r\n            this.sockets = {};\r\n            this.freeSockets = {};\r\n            this.requests = {};\r\n            this.options = {};\r\n        }\r\n        get defaultPort() {\r\n            if (typeof this.explicitDefaultPort === 'number') {\r\n                return this.explicitDefaultPort;\r\n            }\r\n            return isSecureEndpoint() ? 443 : 80;\r\n        }\r\n        set defaultPort(v) {\r\n            this.explicitDefaultPort = v;\r\n        }\r\n        get protocol() {\r\n            if (typeof this.explicitProtocol === 'string') {\r\n                return this.explicitProtocol;\r\n            }\r\n            return isSecureEndpoint() ? 'https:' : 'http:';\r\n        }\r\n        set protocol(v) {\r\n            this.explicitProtocol = v;\r\n        }\r\n        callback(req, opts, fn) {\r\n            throw new Error('\"agent-base\" has no default implementation, you must subclass and override `callback()`');\r\n        }\r\n        /**\r\n         * Called by node-core's \"_http_client.js\" module when creating\r\n         * a new HTTP request with this Agent instance.\r\n         *\r\n         * @api public\r\n         */\r\n        addRequest(req, _opts) {\r\n            const opts = Object.assign({}, _opts);\r\n            if (typeof opts.secureEndpoint !== 'boolean') {\r\n                opts.secureEndpoint = isSecureEndpoint();\r\n            }\r\n            if (opts.host == null) {\r\n                opts.host = 'localhost';\r\n            }\r\n            if (opts.port == null) {\r\n                opts.port = opts.secureEndpoint ? 443 : 80;\r\n            }\r\n            if (opts.protocol == null) {\r\n                opts.protocol = opts.secureEndpoint ? 'https:' : 'http:';\r\n            }\r\n            if (opts.host && opts.path) {\r\n                // If both a `host` and `path` are specified then it's most\r\n                // likely the result of a `url.parse()` call... we need to\r\n                // remove the `path` portion so that `net.connect()` doesn't\r\n                // attempt to open that as a unix socket file.\r\n                delete opts.path;\r\n            }\r\n            delete opts.agent;\r\n            delete opts.hostname;\r\n            delete opts._defaultAgent;\r\n            delete opts.defaultPort;\r\n            delete opts.createConnection;\r\n            // Hint to use \"Connection: close\"\r\n            // XXX: non-documented `http` module API :(\r\n            req._last = true;\r\n            req.shouldKeepAlive = false;\r\n            let timedOut = false;\r\n            let timeoutId = null;\r\n            const timeoutMs = opts.timeout || this.timeout;\r\n            const onerror = (err) => {\r\n                if (req._hadError)\r\n                    return;\r\n                req.emit('error', err);\r\n                // For Safety. Some additional errors might fire later on\r\n                // and we need to make sure we don't double-fire the error event.\r\n                req._hadError = true;\r\n            };\r\n            const ontimeout = () => {\r\n                timeoutId = null;\r\n                timedOut = true;\r\n                const err = new Error(`A \"socket\" was not created for HTTP request before ${timeoutMs}ms`);\r\n                err.code = 'ETIMEOUT';\r\n                onerror(err);\r\n            };\r\n            const callbackError = (err) => {\r\n                if (timedOut)\r\n                    return;\r\n                if (timeoutId !== null) {\r\n                    clearTimeout(timeoutId);\r\n                    timeoutId = null;\r\n                }\r\n                onerror(err);\r\n            };\r\n            const onsocket = (socket) => {\r\n                if (timedOut)\r\n                    return;\r\n                if (timeoutId != null) {\r\n                    clearTimeout(timeoutId);\r\n                    timeoutId = null;\r\n                }\r\n                if (isAgent(socket)) {\r\n                    // `socket` is actually an `http.Agent` instance, so\r\n                    // relinquish responsibility for this `req` to the Agent\r\n                    // from here on\r\n                    debug('Callback returned another Agent instance %o', socket.constructor.name);\r\n                    socket.addRequest(req, opts);\r\n                    return;\r\n                }\r\n                if (socket) {\r\n                    socket.once('free', () => {\r\n                        this.freeSocket(socket, opts);\r\n                    });\r\n                    req.onSocket(socket);\r\n                    return;\r\n                }\r\n                const err = new Error(`no Duplex stream was returned to agent-base for \\`${req.method} ${req.path}\\``);\r\n                onerror(err);\r\n            };\r\n            if (typeof this.callback !== 'function') {\r\n                onerror(new Error('`callback` is not defined'));\r\n                return;\r\n            }\r\n            if (!this.promisifiedCallback) {\r\n                if (this.callback.length >= 3) {\r\n                    debug('Converting legacy callback function to promise');\r\n                    this.promisifiedCallback = promisify_1.default(this.callback);\r\n                }\r\n                else {\r\n                    this.promisifiedCallback = this.callback;\r\n                }\r\n            }\r\n            if (typeof timeoutMs === 'number' && timeoutMs > 0) {\r\n                timeoutId = setTimeout(ontimeout, timeoutMs);\r\n            }\r\n            if ('port' in opts && typeof opts.port !== 'number') {\r\n                opts.port = Number(opts.port);\r\n            }\r\n            try {\r\n                debug('Resolving socket for %o request: %o', opts.protocol, `${req.method} ${req.path}`);\r\n                Promise.resolve(this.promisifiedCallback(req, opts)).then(onsocket, callbackError);\r\n            }\r\n            catch (err) {\r\n                Promise.reject(err).catch(callbackError);\r\n            }\r\n        }\r\n        freeSocket(socket, opts) {\r\n            debug('Freeing socket %o %o', socket.constructor.name, opts);\r\n            socket.destroy();\r\n        }\r\n        destroy() {\r\n            debug('Destroying agent %o', this.constructor.name);\r\n        }\r\n    }\r\n    createAgent.Agent = Agent;\r\n    // So that `instanceof` works correctly\r\n    createAgent.prototype = createAgent.Agent.prototype;\r\n})(createAgent || (createAgent = {}));\r\nmodule.exports = createAgent;\r\n//# sourceMappingURL=index.js.map","\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction promisify(fn) {\r\n    return function (req, opts) {\r\n        return new Promise((resolve, reject) => {\r\n            fn.call(this, req, opts, (err, rtn) => {\r\n                if (err) {\r\n                    reject(err);\r\n                }\r\n                else {\r\n                    resolve(rtn);\r\n                }\r\n            });\r\n        });\r\n    };\r\n}\r\nexports.default = promisify;\r\n//# sourceMappingURL=promisify.js.map"]}